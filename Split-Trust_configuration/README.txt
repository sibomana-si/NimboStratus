/* This document serves as a short tutorial to setting up the
 * Split-Trust configuration for use.
 * It assumes that you have decided to use Dropbox as your Cloud 
 * Storage Provider, and aescrypt as the encryption application.
 * If you decide to use a different encryption application, or 
 * CSP, the steps regarding the installation of the encryption 
 * application/ CSP client may be different.
 * Also if you decide to use a different encryption application
 * you will need to modify the encrypt_script.pl and decrypt_script.pl.
 * Specifically, the lines in the Encrypt function (Sub Encrypt) and 
 * Decrypt function (Sub Decrypt), that specify the syntax of the 
 * encryption application.
 * We also assume that you're setting up this configuration on a linux 
 * machine.
 */

/* STEP 1:
 * Begin by creating a directory for the files required for this 
 * configuration.
 */

	$ mkdir /tmp/split-trust_config_files
	$ cd /tmp/split-trust_config_files

/* STEP 2:
 * Then copy the scripts (split-trust_config.sh, encrypt_script.pl, 
 * and decrypt_script.pl), which we have provided, into this directory.
 * Also download the aescrypt encryption application 
 * (https://www.aescrypt.com/download/v3/linux/aescrypt-3.10.tgz) 
 * into this directory.
 */

	$ cp <PATH TO DIRECTORY WHERE SCRIPTS ARE SAVED>/* /tmp/split-trust_config_files/
	$ wget https://www.aescrypt.com/download/v3/linux/aescrypt-3.10.tgz
 
 
/* STEP 3:
 * Run the configuration setup script 
 */

	$ ./split-trust_config.sh

/* STEP 4:
 * Check that the two docker containers (automated-enc_module and 
 * automated-csp_module) have been created and are running.
 */
 
	$ docker ps

	
/* STEP 5:
 * Transfer the encryption application, and encrypt/decrypt scripts into the
 * encryption container (automated-enc_module)
 */

	$ cp encrypt_script.pl decrypt_script.pl aescrypt-3.10.tgz ~/framework_space/plain_dir/

	
/* STEP 6:
 * access the encryption container 
 */

	$ docker start -i -a automated-enc_module

 < If you don't immediately get the command prompt, press the ENTER key>


/* STEP 7:
 * Transfer the encryption/decryption scripts to the scripts directory 
 * in this container.
 */
 
	# mv /decrypted/encrypt_script.pl /scripts/
	# mv /decrypted/decrypt_script.pl /scripts/


/* STEP 8:
 * Transfer the encryption application to the tmp directory 
 */

	# mv /decrypted/aescrypt-3.10.tgz /tmp/


/* STEP 9:
 * Install encryption application 
 */
	# cd /tmp/
	# tar -xzf aescrypt-3.10.tgz
	# cd aescrypt-3.10/src/
	# make
	# make install

/* STEP 10:
 * Download the keyfile, which contains the default password (randomly generated)
 * that will be used by the encryption application (aescrypt) for encryption/
 * decryption. This step assumes that you are going to setup this configuration on 
 * multiple devices, each synced to the same Dropbox account.
 * Since each time the setup script (split-trust_config.sh) is run on a new machine,
 * a different "keyfile" file will be generated, and we need all the machines to 
 * use the same keyfile for encryption/decryption, the user will have to copy the 
 * file "keyfile" from one of the machines and securely transfer it to the scripts
 * directory of the automated-enc_module container in the other machines that are
 * running this configuration.
 */ 

	# cp /scripts/keyfile /decrypted/

/* STEP 11:
 * Exit the encryption container.
 */

	# exit

	
/* STEP 12:
 * Move keyfile to the split-trust_config_files directory (and immediately transfer it 
 * to the other machines that the user wants to keep in sync.)
 * Make sure to delete it afterwards, so there's no copy of it in an unsecure location.
 */
 
	$ mv ~/framework_space/plain_dir/keyfile /tmp/split-trust_config_files


/* STEP 13:
 * Access the CSP container.
 */

	$ docker start -i -a automated-csp_module

	< If you don't immediately get the command prompt, press the ENTER key>
	
	 
/* STEP 14:
 * Install the Dropbox client application.
 */

	# apt-get install -y wget
	# wget -O - "https://www.dropbox.com/download?plat=lnx.x86_64" | tar xzf -
	# .dropbox-dist/dropboxd
	

/* STEP 15:
 * At this point you are required to copy a link generated by the Dropbox client,
 * to your browser, and to log in to your dropbox account.
 * Once you have completed the login step, the Dropbox installation is complete, and
 * starts synchronizing the Dropbox folder on your machine with your Dropbox account.
 */
 

/* STEP 16:
 * Stop the Dropbox client 
 */
 
	<CTRL-C (simultaneously press the Ctrl and C buttons to stop the dropbox client)>

/* STEP 17:
 * Create a symbolic link in the Dropbox directory, that points to
 * the /csp directory in this container. Then exit the container.
 */
 
	# ln -s /csp/ /root/Dropbox/  
	# exit

	
/* STEP 18:
 * Restart the two containers(automated-enc_module and automated-csp_module) 
 * in the background.
 */

	$ docker start automated-enc_module
	$ docker start automated-csp_module

	
/* STEP 19:
 * Start the incron filesystem monitoring tool. 
 */

	$ docker exec automated-enc_module incrond

	
/* STEP 20:
 * Start the Dropbox client 
 */
	
	$ docker exec automated-csp_module .dropbox-dist/dropboxd

/* You may again be required to authenticate yourself to your
 * Dropbox account, by copying a link generated by the Dropbox client,
 * to your browser, and logging in to the Dropbox account.
 *
 * Enter CTRL - C on the keyboard to get back the command prompt. 
 * At this point you are ready to start syncing files to
 * your dropbox account, by sending/retrieving files to/from
 * the directory 
 * <PATH TO USER'S HOME_DIRECTORY>/framework_space/plain_dir/
 */
 
 
/* USING MULTIPLE MACHINES TO SYNC DATA */ 
 
/* If you are setting up this configuration on two or more machines that 
 * you would like to keep synced with your csp (dropbox) account, the
 * setup procedure on machine 2, 3, ..., is the same as above, 
 * with the following exceptions:
 *
 * - In STEP 2, in addition to copying the scripts, also copy the
 *	  file "keyfile" (obtained from the configuration setup on the
 * 	  first machine, to the directory /tmp/split-trust_config_files/
 *
 * - In STEP 5, in addition to copying the scripts, also copy the
 *   the file "keyfile" retrieved from the first machine. i.e.
 * 	
 *	$ cp keyfile encrypt_script.pl decrypt_script.pl aescrypt-3.10.tgz ~/framework_space/plain_dir/
 *
 * - In STEP 7, in addition to the scripts, move the file "keyfile" to 
 *   the scripts directory:
 *
 *  $ mv /decrypted/keyfile /scripts/
 * 
 * - SKIP STEP 10 and STEP 12.
 */